<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BROP Browser CDP Example</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            margin: 0 0 20px 0;
        }
        .status {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d2e;
            border-left: 4px solid #4caf50;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        .status.warning {
            background: #fff8e1;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 16px;
            margin: 16px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }
        .log-entry.command {
            color: #1976d2;
            font-weight: bold;
        }
        .log-entry.success {
            color: #2e7d2e;
        }
        .log-entry.error {
            color: #c62828;
        }
        .log-entry.info {
            color: #666;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }
        .result {
            background: #f0f7ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
        }
        .screenshot {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌉 BROP Browser CDP Client</h1>
        <p>This example demonstrates controlling Chrome through the BROP extension using JavaScript directly in the browser.</p>
        
        <div id="status" class="status info">Ready to connect...</div>
        
        <div class="controls">
            <button id="connect-btn" onclick="connectToBROP()">Connect to BROP</button>
            <button id="get-version-btn" onclick="getBrowserVersion()" disabled>Get Version</button>
            <button id="get-targets-btn" onclick="getTargets()" disabled>Get Targets</button>
            <button id="navigate-btn" onclick="navigateToExample()" disabled>Navigate to Example.com</button>
            <button id="screenshot-btn" onclick="takeScreenshot()" disabled>Take Screenshot</button>
            <button id="evaluate-btn" onclick="evaluateJS()" disabled>Execute JavaScript</button>
            <button id="clear-log-btn" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="results"></div>
        
        <h3>Activity Log:</h3>
        <div id="log" class="log">
            <div class="log-entry info">🚀 BROP Browser CDP Client ready</div>
            <div class="log-entry info">📋 Click "Connect to BROP" to start</div>
        </div>
    </div>

    <script>
        class BrowserBROPCDPClient {
            constructor() {
                this.ws = null;
                this.pendingRequests = new Map();
                this.nextRequestId = 0;
                this.connected = false;
            }

            async connect(wsUrl = 'ws://localhost:9222') {
                return new Promise((resolve, reject) => {
                    try {
                        this.ws = new WebSocket(wsUrl);
                        
                        this.ws.onopen = () => {
                            this.connected = true;
                            this.log('🔗 Connected to BROP bridge server', 'success');
                            this.enableButtons();
                            resolve();
                        };
                        
                        this.ws.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                this.handleMessage(message);
                            } catch (error) {
                                this.log('❌ Failed to parse message: ' + error.message, 'error');
                            }
                        };
                        
                        this.ws.onclose = () => {
                            this.connected = false;
                            this.log('🔌 Disconnected from BROP bridge server', 'info');
                            this.disableButtons();
                        };
                        
                        this.ws.onerror = (error) => {
                            this.log('🚫 WebSocket error: ' + error.message, 'error');
                            reject(error);
                        };
                    } catch (error) {
                        this.log('❌ Connection failed: ' + error.message, 'error');
                        reject(error);
                    }
                });
            }

            async sendCommand(method, params = {}) {
                if (!this.connected) {
                    throw new Error('Not connected to BROP bridge server');
                }
                
                const id = this.nextRequestId++;
                const message = { id, method, params };
                
                this.log(`📤 ${method}`, 'command');
                this.ws.send(JSON.stringify(message));
                
                return new Promise((resolve, reject) => {
                    this.pendingRequests.set(id, { resolve, reject, method });
                    
                    setTimeout(() => {
                        if (this.pendingRequests.has(id)) {
                            this.pendingRequests.delete(id);
                            reject(new Error(`Timeout waiting for ${method}`));
                        }
                    }, 10000);
                });
            }

            handleMessage({ id, result, error, method, params }) {
                if (id !== undefined && this.pendingRequests.has(id)) {
                    const { resolve, reject, method: requestMethod } = this.pendingRequests.get(id);
                    this.pendingRequests.delete(id);
                    
                    if (error) {
                        this.log(`📥 ${requestMethod} ERROR: ${error.message}`, 'error');
                        reject(new Error(error.message));
                    } else {
                        this.log(`📥 ${requestMethod} SUCCESS`, 'success');
                        resolve(result);
                    }
                }
                
                if (method) {
                    this.log(`📡 Event: ${method}`, 'info');
                }
            }

            log(message, type = 'info') {
                const logDiv = document.getElementById('log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            enableButtons() {
                const buttons = ['get-version-btn', 'get-targets-btn', 'navigate-btn', 'screenshot-btn', 'evaluate-btn'];
                buttons.forEach(id => {
                    document.getElementById(id).disabled = false;
                });
                document.getElementById('connect-btn').textContent = 'Connected ✅';
                document.getElementById('connect-btn').disabled = true;
            }

            disableButtons() {
                const buttons = ['get-version-btn', 'get-targets-btn', 'navigate-btn', 'screenshot-btn', 'evaluate-btn'];
                buttons.forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                document.getElementById('connect-btn').textContent = 'Connect to BROP';
                document.getElementById('connect-btn').disabled = false;
            }

            showResult(title, content) {
                const resultsDiv = document.getElementById('results');
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = `<strong>${title}:</strong><br><pre>${JSON.stringify(content, null, 2)}</pre>`;
                resultsDiv.appendChild(resultDiv);
            }

            showScreenshot(base64Data) {
                const resultsDiv = document.getElementById('results');
                const imgElement = document.createElement('img');
                imgElement.className = 'screenshot';
                imgElement.src = `data:image/png;base64,${base64Data}`;
                imgElement.alt = 'Browser Screenshot';
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = '<strong>Screenshot:</strong><br>';
                resultDiv.appendChild(imgElement);
                resultsDiv.appendChild(resultDiv);
            }
        }

        // Global CDP client instance
        const cdpClient = new BrowserBROPCDPClient();

        // Button handlers
        async function connectToBROP() {
            try {
                document.getElementById('status').textContent = 'Connecting...';
                document.getElementById('status').className = 'status warning';
                
                await cdpClient.connect();
                
                document.getElementById('status').textContent = 'Connected to BROP bridge server ✅';
                document.getElementById('status').className = 'status success';
            } catch (error) {
                document.getElementById('status').textContent = 'Connection failed: ' + error.message;
                document.getElementById('status').className = 'status error';
                cdpClient.log('Connection troubleshooting:', 'info');
                cdpClient.log('1. Make sure bridge server is running (node bridge_server.js)', 'info');
                cdpClient.log('2. Make sure Chrome extension is loaded and connected', 'info');
                cdpClient.log('3. Check browser console for CORS or WebSocket errors', 'info');
            }
        }

        async function getBrowserVersion() {
            try {
                const version = await cdpClient.sendCommand('Browser.getVersion');
                cdpClient.showResult('Browser Version', version);
            } catch (error) {
                cdpClient.log('❌ Get version failed: ' + error.message, 'error');
            }
        }

        async function getTargets() {
            try {
                const response = await cdpClient.sendCommand('Target.getTargets');
                const targets = response.targetInfos || [];
                const pageTargets = targets.filter(t => t.type === 'page');
                
                cdpClient.showResult('Available Targets', {
                    total: targets.length,
                    pageTargets: pageTargets.length,
                    targets: pageTargets.map(t => ({
                        id: t.targetId,
                        title: t.title,
                        url: t.url
                    }))
                });
            } catch (error) {
                cdpClient.log('❌ Get targets failed: ' + error.message, 'error');
            }
        }

        async function navigateToExample() {
            try {
                await cdpClient.sendCommand('Page.navigate', { 
                    url: 'https://example.com' 
                });
                cdpClient.log('🌐 Navigation to example.com started', 'success');
                
                // Wait a moment then get page info
                setTimeout(async () => {
                    try {
                        const titleResult = await cdpClient.sendCommand('Runtime.evaluate', {
                            expression: 'document.title',
                            returnByValue: true
                        });
                        cdpClient.log(`📄 Page title: ${titleResult.result.value}`, 'info');
                    } catch (error) {
                        cdpClient.log('⚠️ Could not get page title: ' + error.message, 'warning');
                    }
                }, 2000);
            } catch (error) {
                cdpClient.log('❌ Navigation failed: ' + error.message, 'error');
            }
        }

        async function takeScreenshot() {
            try {
                const screenshot = await cdpClient.sendCommand('Page.captureScreenshot', {
                    format: 'png'
                });
                cdpClient.showScreenshot(screenshot.data);
                cdpClient.log(`📸 Screenshot captured (${screenshot.data.length} chars base64)`, 'success');
            } catch (error) {
                cdpClient.log('❌ Screenshot failed: ' + error.message, 'error');
            }
        }

        async function evaluateJS() {
            try {
                const expressions = [
                    'document.title',
                    'window.location.href',
                    'document.querySelectorAll("*").length',
                    'document.querySelectorAll("p").length'
                ];
                
                const results = {};
                for (const expr of expressions) {
                    const result = await cdpClient.sendCommand('Runtime.evaluate', {
                        expression: expr,
                        returnByValue: true
                    });
                    results[expr] = result.result.value;
                }
                
                cdpClient.showResult('JavaScript Evaluation Results', results);
                
                // Highlight first link as a demo
                await cdpClient.sendCommand('Runtime.evaluate', {
                    expression: `
                        const links = document.querySelectorAll('a');
                        if (links.length > 0) {
                            links[0].style.backgroundColor = 'yellow';
                            links[0].style.padding = '2px';
                            console.log('Highlighted first link: ' + links[0].textContent);
                        }
                        'Demo: Highlighted first link (check the browser tab)'
                    `,
                    returnByValue: true
                });
                
            } catch (error) {
                cdpClient.log('❌ JavaScript evaluation failed: ' + error.message, 'error');
            }
        }

        function clearLog() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = '<div class="log-entry info">🧹 Log cleared</div>';
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            cdpClient.log('🎯 BROP Browser CDP Client initialized', 'info');
            cdpClient.log('📝 Open browser dev tools to see additional debugging info', 'info');
        });
    </script>
</body>
</html>